# 2025-8-1

## è®°å½•

- ç¼–è¯‘å››ä¸ªæ¶æ„çš„ vdso.so

### é—®é¢˜

- aarch å’Œ loongarch ä¸‹å­˜åœ¨é¡µç‰¹æƒç­‰çº§ä¸åŒ¹é…çš„é—®é¢˜


## ç¬”è®°

### ç¼–è¯‘ Linux

#### é¢„å¤‡å·¥ä½œ

**å®‰è£…ä¾èµ–**

å®¿ä¸»æœºä½¿ç”¨ ArchLinux æ¥ç¼–è¯‘ Linuxï¼Œ å› æ­¤éœ€è¦å‡†å¤‡ä¸€äº›ä¾èµ–é¡¹ã€‚

```bash
sudo pacman -S base-devel bc coreutils cpio gettext initramfs kmod libelf ncurses pahole perl python rsync tar xz
```

**é…ç½®**

æºç ç‰ˆæœ¬ï¼š `v6.2.10`

- defconfig: é»˜è®¤é…ç½®ã€‚
- allmodconfig: æ ¹æ®å½“å‰ç³»ç»ŸçŠ¶æ€ï¼Œå°½å¯èƒ½åœ°æŠŠé¡¹ç›®æ„å»ºä¸ºå¯åŠ è½½æ¨¡å—ï¼ˆè€Œéå†…å»ºï¼‰ã€‚
- tinyconfig: æç®€çš„ Linux å†…æ ¸ã€‚

ç”±äºç¼–è¯‘linuxçš„ç›®çš„æ˜¯å¾—åˆ° vdso.so å› æ­¤é€‰ç”¨ tinyconfig, ç¼–è¯‘é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ã€‚

**ç¼–è¯‘è„šæœ¬**

éœ€è¦æ‰‹åŠ¨å¼€å¯ 64 ä½æ”¯æŒï¼Œ `v6.2.10` é»˜è®¤ä¸å¼€å¯ vdso æº¢å‡ºä¿æŠ¤ï¼Œä½†æ˜¯ `v6.15` é»˜è®¤å¼€å¯ã€‚

```bash
#!/bin/bash
set -e

source $HOME/.env

KERNEL_SRC=$PWD   # å‡è®¾ä½ åœ¨ Linux æºç æ ¹ç›®å½•
OUT_DIR="$PWD/output-vdso"

ARCH_LIST=("x86_64" "aarch64" "riscv64" "loongarch64")
ARCH_NAME_LIST=("x86" "arm64" "riscv" "loongarch")

for i in "${!ARCH_LIST[@]}"; do
    ARCH=${ARCH_LIST[$i]}
    CROSS=$ARCH-linux-musl-
    ARCH_NAME=${ARCH_NAME_LIST[$i]}
    BUILD_DIR="$PWD/build-$ARCH"

    echo "========== Building vDSO for $ARCH =========="

    make O=$BUILD_DIR ARCH=$ARCH_NAME CROSS_COMPILE=$CROSS tinyconfig

    # æ‰‹åŠ¨å¯ç”¨ vdso å’Œæ¶æ„ç‰¹å®šé€‰é¡¹
    scripts/config --file "$BUILD_DIR/.config" -e CONFIG_BIT64
    # scripts/config --file "$BUILD_DIR/.config" -e CONFIG_HYPERVISOR_GUEST
    # scripts/config --file "$BUILD_DIR/.config" -e CONFIG_PARAVIRT 
    scripts/config --file "$BUILD_DIR/.config" -d CONFIG_GENERIC_VDSO_32

    make O=$BUILD_DIR ARCH=$ARCH_NAME CROSS_COMPILE=$CROSS olddefconfig

    echo "--> Compiling Linux ..."
    make O=$BUILD_DIR ARCH=$ARCH_NAME CROSS_COMPILE=$CROSS -j$(nproc) V=1 2>&1 | tee build.log

    echo "--> Copying vDSO to $OUT_DIR/$ARCH"
    mkdir -p "$OUT_DIR/$ARCH"
    find $BUILD_DIR -name "vdso*.so" -exec cp {} "$OUT_DIR/$ARCH/vdso.so" \;
    find $BUILD_DIR -name "vdso*.so.dbg" -exec cp {} "$OUT_DIR/$ARCH/vdso.so.dbg" \;

    echo "âœ… $ARCH vDSO build complete."
    echo
done

echo "ğŸ‰ All architectures built. Output in $OUT_DIR"
```

## å‚è€ƒ

- [æœ€å°é…ç½®çš„ RISC-V Linux å†…æ ¸](https://tinylab.org/minimum-riscv-kernel/)
- [Linux-å†…æ ¸åŠ¨æ‰‹ç¼–è¯‘å®ç”¨æŒ‡å—](https://www.debian.com.cn/%E6%8A%80%E6%9C%AF/linuxcn/Linux-%E5%86%85%E6%A0%B8%E5%8A%A8%E6%89%8B%E7%BC%96%E8%AF%91%E5%AE%9E%E7%94%A8%E6%8C%87%E5%8D%97/)

